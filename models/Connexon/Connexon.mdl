#ifndef Connexon_MDL
#define Connexon_MDL

#include "../../nti/include/MaxComputeOrder.h"

#include "../std/std.mdl"
#include "../BranchSolver/BranchSolver.mdl"
#include "../HodgkinHuxley/HodgkinHuxley.mdl"

// A Connexon is a gap junctionn
//      bidirectional connection between
//      2 compartmental branches
Node Connexon Implements CurrentProducer, BranchDataProducer, IndexProducer, 
     VoltageProducer
{ // for historical purpose (we still keep it here; use Connexon_Vm instead)
/*{{{*/
  dyn_var_t* Vi; //reference to the compartment representing the spine neck 
  dyn_var_t* Vj; //reference to the compartment representing the spine 'head'
  dyn_var_t I;   //the current [pA]
  dyn_var_t g;   //the conductance [nS] between the gap junction formed by 2 compartments
                 // .. from 2 different branches

  BranchDataStruct* branchData; // reference to the branch having the compartment of Vi
  int index;

  Shared {
    dyn_var_t []* voltageConnect;
  }

  InitPhase produceInitialVoltage(Vi);
  RuntimePhase produceVoltage(Vi), computeState;

  VoltageProducer.voltage << Vi;
  CurrentProducer.current << &I;
  BranchDataProducer.branchData << branchData;
  IndexProducer.index << &index;

  InAttrPSet {
    string identifier;
    int idx;
  }

  UserFunction setPointers;
  
  Connection Pre Node (PSet.identifier=="compartment[Voltage]") Expects 
    VoltageArrayProducer, BranchDataProducer 
  {
    VoltageArrayProducer.voltageArray >> Shared.voltageConnect;
    BranchDataProducer.branchData >> branchData;
    setPointers();
  }
  Connection Pre Node (PSet.identifier=="connexon[Voltage]") Expects 
    VoltageProducer 
  {
    VoltageProducer.voltage >> Vj;
  }
/*}}}*/
}

#endif
