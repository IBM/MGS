// =================================================================
// Licensed Materials - Property of IBM
//
// "Restricted Materials of IBM"
//
// BCM-YKT-07-18-2017
//
// (C) Copyright IBM Corp. 2005-2017  All rights reserved
//
// US Government Users Restricted Rights -
// Use, duplication or disclosure restricted by
// GSA ADP Schedule Contract with IBM Corp.
//
// =================================================================

#ifndef BENGIORATEPYRAMIDAL_MDL
#define BENGIORATEPYRAMIDAL_MDL
#include "../PointNeuronTools/PointNeuronTools.mdl"

Node BengioRatePyramidal Implements FiringRateProducer, OutputProducer {
   // These variable names are according to arXiv.org > q-bio > arXiv:1801.00062
   // Dendritic error backpropagation in deep cortical microcircuits
   // Jo√£o Sacramento, Rui Ponte Costa, Yoshua Bengio, Walter Senn

   double u;
   double phi_u;
   double v_B;
   double v_A;
   double i;


   Input [] interneuronInputs;
   Input [] pyramidalForwardInputs;
   double* [] pyramidalTeachingInputs;
   Input [] pyramidalBackwardInputs; // Top Down
   
   Shared {
     double g_lk;
     double g_B;
     double g_A;
     double sigma;
     double E_inh;
     double E_exc;
     double g_som;
     double eta_PI;
     double eta_PP;
     double v_rest;
     double i_toggle;
     double dT;

     double predictionFactor;

     string sharedDirectory;
     string sharedFileExt;     
     int [] collectWeightsOn;
     int collectWeightsNext;
     bool saveBinary;
     
     RuntimePhase outputWeightsShared;
     InitPhase initialize();
   }

   InAttrPSet {
     string identifier;
     double weight;
   }

   RuntimePhase update_U(phi_u, u);
   RuntimePhase update_Vs; // Vs is plural (V_A and V_B)

   FiringRateProducer.output << &phi_u;
   OutputProducer.output << &u;

   Connection Pre Node (PSet.identifier=="interneuron") Expects FiringRateProducer {
      FiringRateProducer.output >> interneuronInputs.input;
      PSet.weight >> interneuronInputs.weight;
   }

   Connection Pre Node (PSet.identifier=="sensory") Expects OutputProducer {
      OutputProducer.output >> pyramidalForwardInputs.input;
      PSet.weight >> pyramidalForwardInputs.weight;
   }

   Connection Pre Node (PSet.identifier=="forward") Expects FiringRateProducer {
      FiringRateProducer.output >> pyramidalForwardInputs.input;
      PSet.weight >> pyramidalForwardInputs.weight;
   }

   Connection Pre Node (PSet.identifier=="backward") Expects FiringRateProducer, OutputProducer {
      OutputProducer.output >> pyramidalTeachingInputs;
      FiringRateProducer.output >> pyramidalBackwardInputs.input;
      PSet.weight >> pyramidalBackwardInputs.weight;      
   }
}
#endif
