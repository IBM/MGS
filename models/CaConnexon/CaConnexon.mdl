#ifndef CaConnexon_MDL
#define CaConnexon_MDL

#include "../std/std.mdl"
#include "../BranchSolver/BranchSolver.mdl"
#include "../HodgkinHuxley/HodgkinHuxley.mdl"

Node CaConnexon Implements VoltageProducer, CaConcentrationProducer, CurrentProducer, CaCurrentProducer, BranchDataProducer, IndexProducer {
  dyn_var_t* Vi;
  dyn_var_t* Vj;
  dyn_var_t I;
  dyn_var_t* Cai;
  dyn_var_t* Caj;
  dyn_var_t I_Ca;
  dyn_var_t g;

  BranchDataStruct* branchData;
  int index;

  Shared {
    dyn_var_t* T;
    dyn_var_t []* voltageConnect;
    dyn_var_t []* CaConcentrationConnect;
  }

  InitPhase produceInitialState(Vi, Cai);
  RuntimePhase produceState(Vi, Cai), computeState;

  VoltageProducer.voltage << Vi;
  CurrentProducer.current << &I;
  CaConcentrationProducer.Ca << Cai;
  CaCurrentProducer.current << &I_Ca;
  BranchDataProducer.branchData << branchData;
  IndexProducer.index << &index;

  InAttrPSet {
    string identifier;
    int idx;
    float branchProp;
  }

  UserFunction setCaPointers;
  UserFunction setVoltagePointers; 
 
  Connection Pre Constant (PSet.identifier=="EC") Expects TemperatureProducer {
    TemperatureProducer.T >> Shared.T;
  }
  Connection Pre Node (PSet.identifier=="compartment[Calcium]") Expects CaConcentrationArrayProducer {
    CaConcentrationArrayProducer.CaConcentrations >> Shared.CaConcentrationConnect;
    setCaPointers();
  }
  Connection Pre Node (PSet.identifier=="compartment[Voltage]") Expects VoltageArrayProducer, BranchDataProducer {
    VoltageArrayProducer.voltageArray >> Shared.voltageConnect;
    BranchDataProducer.branchData >> branchData;
    setVoltagePointers();
  }
  Connection Pre Node (PSet.identifier=="connexon[Voltage]") Expects VoltageProducer {
    VoltageProducer.voltage >> Vj;
  }
  Connection Pre Node (PSet.identifier=="connexon[Calcium]") Expects CaConcentrationProducer {
    CaConcentrationProducer.Ca >> Caj;
  }
}

#endif
