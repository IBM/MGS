#ifndef PreSynapticPoint_MDL
#define PreSynapticPoint_MDL

#include "../../nti/include/MaxComputeOrder.h"

#include "../std/std.mdl"
#include "../HodgkinHuxley/HodgkinHuxley.mdl"
#include "../BranchSolver/BranchSolver.mdl"

//There are two options to use here when implementing postsynaptic receptors
// 1. PreSynapticPoint -- if the receptor want to get directly the voltage
//          and then decide what to do with it
// 2. SynapticCleft    -- if the receptor want to get the concentration of neurotransmitter
//          and then decide what to do with it
// ALSO, note there are two implementation of Synapse/MixedSynapse
// MixedSynapse ~ A receptor (e.g. NMDAR) exerts an effect on the other receptor on the same Synapse (e.g. emulate plasticity effect)
// IMPLEMENTATION 1 ~  RECEPTOR_PRE_AS_INPUT_POST_AS_INPUT_OUTPUT
//     originally design for PreSynapticPoint 
//     the receptor receives directly the compartment (e.g. Voltage, Calcium)
//     AMPAR [Voltage, Calcium] [Voltage] 
//            \____pre ______ / \ post  /
//             as in/out        as in/out
//     This enable the receptor to be on pre-side or post-side
// IMPLEMENTATION 2
//     designed for SynapticCleft
//     the receptor receives directly the compartment (e.g. Voltage, Calcium)
//         on Post-side
//         and implicitly the proper neurotransmitter from SynapticCleft
//     AMPAR [Voltage, Calcium] [Voltage] 
//            \____post ______ / \ post  /
//             as input           as output

// PreSynapticPoint is used as an intermediate node connecting
//   pre-Compartment[Node]  --> PreSynapticPoint --> one-or-many Receptor(Synapse)
//NOTE: obsolete feature TO BE REMOVED
Node PreSynapticPoint Implements BranchDataProducer, IndexProducer
   , VoltageProducer 
{
/*{{{*/
  //{{{DATA
  //{{{pre-side
  dyn_var_t* voltage;
  BranchDataStruct branchData;//data that branchDataConnect point to
  int index; //index of compartment in Presynaptic-side (i.e. bouton)
  //}}}
  Shared {
    dyn_var_t []* voltageConnect;
    BranchDataStruct* branchDataConnect;//point to preSynaptic compartment's branch
  }
  //}}}

  // Output
  //{{{ 
  VoltageProducer.voltage << voltage;
  BranchDataProducer.branchData << &branchData;
  IndexProducer.index << &index;
  //}}}

  //{{{Phases
  //NOTE: As voltage is used by receptors which can be in another process, 
  // it needs to be sync to proxy node
  InitPhase produceInitialState(voltage, branchData, index);
  RuntimePhase produceState(voltage);
  //}}}
  UserFunction setPointers;

  InAttrPSet {
    string identifier;
    int idx;
    float branchProp;
  }

  //{{{Input (Connection setup)
  Connection Pre Node (PSet.identifier=="compartment[Voltage]") Expects VoltageArrayProducer
        , BranchDataProducer 
  {
    //{{{ 
    VoltageArrayProducer.voltageArray >> Shared.voltageConnect;
    BranchDataProducer.branchData >> Shared.branchDataConnect;
    setPointers();
    //}}}
  }
  //}}} 
/*}}}*/
}

// A Cleft instance is uniquely identified by 
//             a single post-side with one-or-many pre-side
//             So, the spine-head key is used to identify how many cleft to created
//      LIMITATION: Currently only support 1pre-side as *Vpre is a single pointer
// It is used as an intermediate node connecting
//   pre-Compartment[Node]  --> SynapticCleft --> Receptor(Synapse)
// However, here it has the states where NT is/are computed
// NOTE: 
//  There is no option to specify nodeType (e.g. Voltage) from pre-Compartment
//  (ASSUME always 'Voltage' receive) - Check TissueFunctor
//  There is no capability to specify 'receptor' on pre-side only
//  (ASSUME always on post-side)
//  The original approach 'unintentionally enable' receptor on post-side and pre-side
//    with the limitation always assume the receptor receive and produce
//    the same information ()
//    though we need to have different name, and it is error prone (or not biological)
//    to have a receptor that receives from both pre-side and post-side
Node SynapticCleft Implements 
    GlutamateConcentrationProducer, GABAConcentrationProducer
#if SUPPORT_MODULABLE_CLEFT
    , DopamineConcentrationProducer, SerotonineConcentrationProducer
    , AchetylcholineConcentrationProducer
//TUAN TODO: add ACh, as FSI producing ACh is common in MSN
#endif
    , NameProducer
#ifdef KEEP_PAIR_PRE_POST
    , DimensionArrayProducer //for pre and post, in that order (used for I/O purpose)
    , BranchDataArrayProducer
    , DirectIndexArrayProducer
#else
   //NOT SUPPORT  (to be removed this option as it's not worthy)
    //BranchDataProducer
    //, IndexProducerPre, IndexProducerPost
    //, BranchDataProducerPre, BranchDataProducerPost
    //, AnyConcentrationProducer
#endif
{
/*{{{*/
  //{{{DATA
  string cleftName;// name of SynapticCleft - NOTE: TUAN TODO not being used right now-will be passed in via the pre-compartment connection; which is identified via the Touch* and associated map structure - this will be used for enhanced Probe purpose, i.e. 'site', 'side' and 'name' attributes
  //{{{cleft-info
  dyn_var_t Glut; // [uM]  Glutamate concentration
  dyn_var_t GABA; // [uM]  GABA concentration
#if SUPPORT_MODULABLE_CLEFT
  dyn_var_t DA; // [uM]    Dopamine concentration
  dyn_var_t Ser; // [uM]   Serotonin concentration
#endif
  //dyn_var_t IP3; // [uM]  IP3 concentration - consider here or inside IP3R channels
  //}}} 
  //{{{pre-side info
  dyn_var_t* Vpre; //presynaptic voltage Vpre
  //int index; //index of compartment in Presynaptic-side (i.e. bouton) - no longer needed as the information is the first element every 2-element tuple in indexPrePost
  //  This is to enable a cleft formed by multiple pre-post pair
  //}}}
  //{{{both-side
  int [] indexPrePost; // array of 2n elements: in pair (preIdx,postIdx)
  BranchDataStruct* [] branchDataPrePost; // array of 2n elements; in pair (preBD, postBD)
  DimensionStruct * [] dimensionsPrePost; // array of 2n elements; in pair (preBD, postBD)
  //}}}
  //BranchDataStruct branchDataPre;//data that branchDataConnect point to
  //BranchDataStruct branchDataPost;//data  from Post-side (NOT being used now - see TUAN TODO)
  //}}}

  Shared {
    //{{{
    dyn_var_t Glut_baseline;
    dyn_var_t Glut_max;
    dyn_var_t GABA_baseline;
    dyn_var_t GABA_max;
#if SUPPORT_MODULABLE_CLEFT
    dyn_var_t DA_baseline;
    dyn_var_t DA_max;
    dyn_var_t Ser_baseline;
    dyn_var_t Ser_max;
#endif
				//{{{ parameter using Destexhe-Mainen-Sejnowski-1994 smooth sigmoid curve
    dyn_var_t Vp_Glut;        // mV   half-max of Glut
    dyn_var_t Kp_Glut;        // mV   steepness of Glut increase
    dyn_var_t tau_Glut; // [ms] time constant for uptake Glu
    dyn_var_t Vp_GABA;        // mV
    dyn_var_t Kp_GABA;        // mV
    dyn_var_t tau_GABA; // [ms] time constant for uptake GABA
#if SUPPORT_MODULABLE_CLEFT
    dyn_var_t Vp_DA;        // mV   half-max of DA
    dyn_var_t Kp_DA;        // mV   steepness of DA increase
    dyn_var_t tau_DA; // [ms] time constant for uptake DA
    dyn_var_t Vp_Ser;        // mV
    dyn_var_t Kp_Ser;        // mV
    dyn_var_t tau_Ser; // [ms] time constant for uptake Ser
#endif
        //}}}
    dyn_var_t* deltaT; // [ms]
    dyn_var_t []* voltageConnect; //temporary use
    //BranchDataStruct* branchDataConnect;//temporary use 
          //can point to preSynaptic cpt's branch or postSynaptic cpt's branch
    //}}}
  }

  // Output
  //{{{ 
  GlutamateConcentrationProducer.NT << &Glut;
  GABAConcentrationProducer.NT << &GABA;
  //AnyConcentrationProducer.AnyConc << &Glut;
#if SUPPORT_MODULABLE_CLEFT
  DopamineConcentrationProducer.NT << &DA;
  SerotonineConcentrationProducer.NT << &Ser;
#endif
  //IndexProducer.index << &index; //pre-synaptic Index
  //BranchDataProducer.branchData << &branchDataPre; //default is from Pre-synaptic side
  //BranchDataProducerPre.branchData << &branchDataPre;
  //BranchDataProducerPost.branchData << &branchDataPost;
  BranchDataArrayProducer.branchDataArray << &branchDataPrePost;
  DirectIndexArrayProducer.indexArray << &indexPrePost;
  DimensionArrayProducer.dimensionArray << &dimensionsPrePost;
  NameProducer.name << &cleftName;
  //}}}

  //{{{Phases 
  //NOTE: As neurotransmitter is used by receptors which can be in another process, 
  // it needs to be sync to proxy node
  //InitPhase produceInitialState(Glut, GABA, branchDataPre, branchDataPost, index);
  InitPhase produceInitialState(Glut, GABA 
#if SUPPORT_MODULABLE_CLEFT
       , DA, Ser
#endif
      );
  RuntimePhase produceState(Glut, GABA
#if SUPPORT_MODULABLE_CLEFT
       , DA, Ser
#endif
      );
  //}}}
  UserFunction setPointers;

  InAttrPSet {
    string identifier;
    int idx;
    string side; // 'pre' or 'post'
  }

  //{{{ Input (Connection setup)
  Connection Pre Node ((PSet.identifier=="compartment[Voltage]") 
                       && (PSet.side=="pre")) Expects 
       VoltageArrayProducer
       , BranchDataProducer 
       , DimensionArrayProducer
  {//from pre-side (i.e. axonal terminal)
    //{{{ 
    VoltageArrayProducer.voltageArray >> Shared.voltageConnect;
    //BranchDataProducer.branchData >> Shared.branchDataConnect;
    BranchDataProducer.branchData >> branchDataPrePost;
    DimensionArrayProducer.dimensionArray >> dimensionsPrePost;
    setPointers();
    //}}}
  }
  Connection Pre Node ((PSet.identifier=="compartment[Voltage]") 
                      && (PSet.side=="post")) Expects 
       BranchDataProducer 
       , DimensionArrayProducer
  {//from post-side 
    //{{{ 
    //BranchDataProducer.branchData >> Shared.branchDataConnect;
    BranchDataProducer.branchData >> branchDataPrePost;
    DimensionArrayProducer.dimensionArray >> dimensionsPrePost;
    setPointers();
    //}}}
  }
  Connection Pre Constant (PSet.identifier=="dt") Expects TimeStepProducer {
    TimeStepProducer.deltaT >> Shared.deltaT;
  }
  //}}}
/*}}}*/
}
#endif
